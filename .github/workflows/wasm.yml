######################################################
##                                                  ##
##  !!!! Autogenerated YAML file, do not edit !!!!  ##
##                                                  ##
##  Edit source in /src/github/workflows/ instead!  ##
##                                                  ##
######################################################
env:
  AGDA_NO_EXEC: 'true'
  AGDA_TESTS_OPTIONS: -j${PARALLEL_TESTS} --hide-successes
  PARALLEL_TESTS: 2
  TASTY_ANSI_TRICKS: 'false'
jobs:
  build:
    if: |
      !contains(github.event.head_commit.message, '[skip ci]')
      && !contains(github.event.head_commit.message, '[ci skip]')
      && !contains(github.event.head_commit.message, '[github skip]')
      && !contains(github.event.head_commit.message, '[skip github]')
    runs-on: ubuntu-24.04
    steps:
    - if: github.ref != 'refs/heads/master'
      uses: styfle/cancel-workflow-action@0.12.1
      with:
        access_token: ${{ github.token }}
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: cachix/install-nix-action@v31
    - name: Setup Cabal
      run: nix develop --command bash -c "wasm32-wasi-cabal update && cabal update"
    - name: Build Agda (WASM)
      run: nix develop --command wasm32-wasi-cabal build -fdebug -foptimise-heavily
    - name: Build Agda (native)
      run: nix develop --command make CABAL_FLAG_ICU= install-bin
    - id: test-setup
      name: Setup test environment
      run: |
        echo "AGDA_WASM=$(nix develop --command wasm32-wasi-cabal list-bin agda 2> /dev/null)" >> $GITHUB_ENV
        echo "AGDA_BIN=$PWD/test/run-agda-wasm.sh" >> $GITHUB_ENV
    - name: Suite of tests for bugs
      run: nix develop --command make bugs
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: 'Suite of successful tests: mini-library Common'
      run: nix develop --command make common
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: Suite of successful tests
      run: nix develop --command make succeed
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: Suite of failing tests
      run: nix develop --command make fail
name: Build and test WASM
'on':
  pull_request:
    paths:
    - '**'
    - '!.github/**'
    - .github/workflows/wasm.yml
    - '!src/github/**'
    - src/github/workflows/wasm.yml
    - '!doc/**'
    - doc/user-manual/**/*.lagda.rst
    - '!src/agda-bisect/**'
    - '!src/fix-whitespace/**'
    - '!src/hs-tags/**'
    - '!src/release-tools/**'
    - '!.travis'
    - '!macros/**'
    - '!notes/**'
    - '!.mailmap'
    - '!.gitignore'
    - '!.hlint.yaml'
    - '!.readthedocs.yaml'
    - '!.travis.yml'
    - '!CHANGELOG.md'
    - '!HACKING.md'
    - '!LICENSE'
    - '!README.md'
    - '!fix-whitespace.yaml'
    - '!hie*.yaml'
    - '!stack-*.yaml'
    - '!touchup.sh'
    - '!CITATION.cff'
  push:
    branches:
    - master
    - ci-*
    - release*
    paths:
    - '**'
    - '!.github/**'
    - .github/workflows/wasm.yml
    - '!src/github/**'
    - src/github/workflows/wasm.yml
    - '!doc/**'
    - doc/user-manual/**/*.lagda.rst
    - '!src/agda-bisect/**'
    - '!src/fix-whitespace/**'
    - '!src/hs-tags/**'
    - '!src/release-tools/**'
    - '!.travis'
    - '!macros/**'
    - '!notes/**'
    - '!.mailmap'
    - '!.gitignore'
    - '!.hlint.yaml'
    - '!.readthedocs.yaml'
    - '!.travis.yml'
    - '!CHANGELOG.md'
    - '!HACKING.md'
    - '!LICENSE'
    - '!README.md'
    - '!fix-whitespace.yaml'
    - '!hie*.yaml'
    - '!stack-*.yaml'
    - '!touchup.sh'
    - '!CITATION.cff'
  workflow_dispatch: null
