######################################################
##                                                  ##
##  !!!! Autogenerated YAML file, do not edit !!!!  ##
##                                                  ##
##  Edit source in /src/github/workflows/ instead!  ##
##                                                  ##
######################################################
env:
  AGDA_NO_EXEC: 'true'
  AGDA_TESTS_OPTIONS: -j${PARALLEL_TESTS} --hide-successes
  PARALLEL_TESTS: 2
  TASTY_ANSI_TRICKS: 'false'
jobs:
  build:
    if: |
      contains(github.event.head_commit.message, '[wasm]')
      || contains(github.event.pull_request.title, '[wasm]')
      || github.event_name == 'schedule'
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    steps:
    - if: github.ref != 'refs/heads/master'
      uses: styfle/cancel-workflow-action@0.13.0
      with:
        access_token: ${{ github.token }}
    - id: check_mnt
      name: Check if /mnt is a mountpoint
      run: |
        echo "Running df:"
        result=$(df)
        echo "$result"
        if echo "$result" | awk '{print $6}' | grep -q '/mnt'; then
          echo "found=1" >> "${GITHUB_OUTPUT}"
        fi
    - if: steps.check_mnt.outputs.found
      uses: easimon/maximize-build-space@v10
      with:
        remove-android: true
        remove-codeql: true
        remove-docker-images: true
        remove-dotnet: true
        remove-haskell: true
        root-reserve-mb: 30000
    - uses: actions/checkout@v6
      with:
        submodules: recursive
    - uses: cachix/install-nix-action@v31
    - name: Setup Cabal
      run: nix develop --command bash -c "wasm32-wasi-cabal update && cabal update"
    - name: Build Agda (WASM)
      run: nix develop --command wasm32-wasi-cabal build -fdebug -foptimise-heavily
    - name: Build Agda (native)
      run: nix develop --command make CABAL_FLAG_ICU= install-bin
    - id: test-setup
      name: Setup test environment
      run: |
        echo "AGDA_WASM=$(nix develop --command wasm32-wasi-cabal list-bin agda 2> /dev/null)" >> "${GITHUB_ENV}"
        echo "AGDA_BIN=$PWD/test/run-agda-wasm.sh" >> "${GITHUB_ENV}"
    - name: Run Agda setup (WASM)
      run: nix develop --command "$AGDA_BIN" --setup
    - name: Suite of tests for bugs
      run: nix develop --command make bugs
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: 'Suite of successful tests: mini-library Common'
      run: nix develop --command make common
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: Suite of successful tests
      run: nix develop --command make succeed
    - if: ${{ !cancelled() && steps.test-setup.conclusion == 'success' }}
      name: Suite of failing tests
      run: nix develop --command make fail
name: Build and test WASM
'on':
  pull_request:
    branches:
    - master
    paths:
    - .github/workflows/wasm.yml
    - src/github/workflows/wasm.yml
    - Agda.cabal
    - cabal.project
    - Makefile
    - flake.lock
    - flake.nix
    - src/full/Agda/**
    - src/main/**
    - src/setup/Agda/**
    - src/agda-mode/**
    - src/data/lib/**
    - test/run-agda-wasm.sh
    - test/**/*.hs
    - test/Bugs/**
    - test/Common/**
    - test/Fail/**
    - test/Succeed/**
  push:
    branches:
    - master
    - ci-*
    - release*
    paths:
    - .github/workflows/wasm.yml
    - src/github/workflows/wasm.yml
    - Agda.cabal
    - cabal.project
    - Makefile
    - flake.lock
    - flake.nix
    - src/full/Agda/**
    - src/main/**
    - src/setup/Agda/**
    - src/agda-mode/**
    - src/data/lib/**
    - test/run-agda-wasm.sh
    - test/**/*.hs
    - test/Bugs/**
    - test/Common/**
    - test/Fail/**
    - test/Succeed/**
  schedule:
  - cron: 0 0 * * 0
  workflow_dispatch: null
