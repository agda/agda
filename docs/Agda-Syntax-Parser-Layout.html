<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Agda.Syntax.Parser.Layout</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">Agda</span><ul class="links" id="page-menu"><li><a href="src/Agda.Syntax.Parser.Layout.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Agda.Syntax.Parser.Layout</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module contains the lex actions that handle the layout rules. The way
    it works is that the <code><a href="Agda-Syntax-Parser-Monad.html#t:Parser" title="Agda.Syntax.Parser.Monad">Parser</a></code> monad keeps track of a stack of
    <code><a href="Agda-Syntax-Parser-Monad.html#t:LayoutContext" title="Agda.Syntax.Parser.Monad">LayoutContext</a></code>s specifying the indentation of the layout blocks in scope.
    For instance, consider the following incomplete (Haskell) program:</p><pre>f x = x'
  where
    x' = do y &lt;- foo x; bar ...</pre><p>At the <code class="inline-code">...</code> the layout context would be</p><pre>[Layout 12, Layout 4, Layout 0]</pre><p>The closest layout block is the one following <code class="inline-code">do</code> which is
    started by token <code class="inline-code">y</code> at column 12.  The second closest block is the
    <code class="inline-code">where</code> clause started by the <code class="inline-code">x'</code> token which has indentation 4.
    Finally, there is a top-level layout block with indentation 0.</p><p>In April 2021 we changed layout handling in the lexer to allow
    stacking of layout keywords on the same line, e.g.:</p><pre>private module M where
   postulate A : Set
             private
               B : Set</pre><p>The layout columns in the layout context (stack of layout blocks) can
    have <code><a href="Agda-Syntax-Parser-Monad.html#t:LayoutStatus" title="Agda.Syntax.Parser.Monad">LayoutStatus</a></code> either <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> or <code><a href="Agda-Syntax-Parser-Monad.html#v:Confirmed" title="Agda.Syntax.Parser.Monad">Confirmed</a></code>. New layout
    columns following a layout keyword are tentative until we see a new
    line. E.g.</p><ul><li>The first <code class="inline-code">private</code> block (column 8) is <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> when we
        encounter the layout keyword <code class="inline-code">where</code>.</li><li>The <code class="inline-code">postulate</code> block (column 12) is <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> until the newline
        after <code class="inline-code">A : Set</code>.</li></ul><p>In contrast,</p><ul><li>The <code class="inline-code">module</code> block (column 2) is <code><a href="Agda-Syntax-Parser-Monad.html#v:Confirmed" title="Agda.Syntax.Parser.Monad">Confirmed</a></code> from the beginning
        since the first token (<code class="inline-code">postulate</code>) after the layout keyword <code class="inline-code">where</code>
        is on a new line.</li><li>The second <code class="inline-code">private</code> block (column 14) is also <code><a href="Agda-Syntax-Parser-Monad.html#v:Confirmed" title="Agda.Syntax.Parser.Monad">Confirmed</a></code> from the
        beginning (for the same reason).</li></ul><p>A new layout column has to be strictly above the last <strong>confirmed</strong>
    column only. E.g., when encountering <code class="inline-code">postulate</code> at column 2 after
    <code class="inline-code">where</code>, the confirmed column is still 0, so this is a valid start of
    the block following <code class="inline-code">where</code>.</p><p>The column 8 of the <code class="inline-code">private</code> block never enters the <code><a href="Agda-Syntax-Parser-Monad.html#v:Confirmed" title="Agda.Syntax.Parser.Monad">Confirmed</a></code> status
    but remains <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code>. Also, this block can never get more than the
    one declaration it has (<code class="inline-code">module...</code>), because when the <code class="inline-code">module</code> block
    closes due to a column &lt; 2, it closes as well. One could say that
    tentative blocks buried under confirmed blocks are passive, the only
    wait for their closing.</p><p>To implement the process of block confirmation (function
    <code><a href="Agda-Syntax-Parser-Layout.html#v:confirmLayout" title="Agda.Syntax.Parser.Layout">confirmLayout</a></code>), the lexer has to act on newline characters (except for
    those in a block comment).</p><ul><li>In ordinary mode, when encountering a newline, we confirm the top
        unconfirmed blocks. Example: The newline after <code class="inline-code">A : Set</code> confirms
        the column 12 after <code class="inline-code">postulate</code>. Function: <code class="inline-code">confirmLayoutAtNewLine</code>,
        state <code class="inline-code">bol</code>.</li><li>In the <code class="inline-code">layout</code> state following a layout keyword, a newline does not
        confirm any block, but announces that the next block should be
        confirmed from the start. Function: <code class="inline-code">confirmedLayoutComing</code>.</li></ul><p>In order to implement <code class="inline-code">confirmedLayoutComing</code> we have a <code><a href="Agda-Syntax-Parser-Monad.html#t:LayoutStatus" title="Agda.Syntax.Parser.Monad">LayoutStatus</a></code>
    flag in the parse state (field <code class="inline-code">stateLayStatus</code>). By default, for a new
    layout block, the status is <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> (unless we saw a newline).</p><p>New layout blocks are created as follows. When a layout keyword is
    encountered, we enter lexer state <code><a href="Agda-Syntax-Parser-Lexer.html#v:layout" title="Agda.Syntax.Parser.Lexer">layout</a></code> via function <code><a href="Agda-Syntax-Parser-Layout.html#v:withLayout" title="Agda.Syntax.Parser.Layout">withLayout</a></code>.
    When we exit the <code><a href="Agda-Syntax-Parser-Lexer.html#v:layout" title="Agda.Syntax.Parser.Lexer">layout</a></code> state via <code><a href="Agda-Syntax-Parser-Layout.html#v:newLayoutBlock" title="Agda.Syntax.Parser.Layout">newLayoutBlock</a></code> with a token that
    marks the new layout column, we push a new <code><a href="Agda-Syntax-Parser-Monad.html#t:LayoutBlock" title="Agda.Syntax.Parser.Monad">LayoutBlock</a></code> onto the
    <code><a href="Agda-Syntax-Parser-Monad.html#t:LayoutContext" title="Agda.Syntax.Parser.Monad">LayoutContext</a></code> using the given column and the current <code><a href="Agda-Syntax-Parser-Monad.html#v:parseLayStatus" title="Agda.Syntax.Parser.Monad">parseLayStatus</a></code>
    which is then reset to <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code>.</p><p>The new block is actually only pushed if the column is above the last
    confirmed layout column (<code class="inline-code">confirmedLayoutColumn</code>). If this check fails,
    we instead enter the <code><a href="Agda-Syntax-Parser-Lexer.html#v:empty_layout" title="Agda.Syntax.Parser.Lexer">empty_layout</a></code> state. This state produces the
    closing brace and is immediately left for <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> (beginning of line).</p><p>(Remark: In <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> we might confirm some tentative top blocks, but this
    is irrelevant, since they will be closed immediately, given that the
    current token is left of the confirmed column, and tentative columns
    above it must be to the right of this column.)</p><p>The <code><a href="Agda-Syntax-Parser-Layout.html#v:offsideRule" title="Agda.Syntax.Parser.Layout">offsideRule</a></code> (state <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code>) is unchanged. It checks how the first
    token on a new line relates to the top layout column, be it tentative or
    confirmed. (Since we are on a new line, <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> can only happen when
    we popped some <code><a href="Agda-Syntax-Parser-Monad.html#v:Confirmed" title="Agda.Syntax.Parser.Monad">Confirmed</a></code> columns and continue popping the top
    <code><a href="Agda-Syntax-Parser-Monad.html#v:Tentative" title="Agda.Syntax.Parser.Monad">Tentative</a></code> columns here.) While the token is to the left of the layout
    column, we keep closing blocks.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:withLayout">withLayout</a> :: <a href="Agda-Syntax-Parser-Tokens.html#t:Keyword" title="Agda.Syntax.Parser.Tokens">Keyword</a> -&gt; <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> r -&gt; <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> r</li><li class="src short"><a href="#v:offsideRule">offsideRule</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a></li><li class="src short"><a href="#v:newLayoutBlock">newLayoutBlock</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a></li><li class="src short"><a href="#v:emptyLayout">emptyLayout</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a></li><li class="src short"><a href="#v:confirmLayout">confirmLayout</a> :: <a href="Agda-Syntax-Parser-Monad.html#t:Parser" title="Agda.Syntax.Parser.Monad">Parser</a> ()</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:withLayout" class="def">withLayout</a> :: <a href="Agda-Syntax-Parser-Tokens.html#t:Keyword" title="Agda.Syntax.Parser.Tokens">Keyword</a> -&gt; <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> r -&gt; <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> r <a href="src/Agda.Syntax.Parser.LexActions.html#withLayout" class="link">Source</a> <a href="#v:withLayout" class="selflink">#</a></p><div class="doc"><p>Executed for layout keywords. Enters the <code><a href="Agda-Syntax-Parser-Lexer.html#v:layout" title="Agda.Syntax.Parser.Lexer">layout</a></code>
   state and performs the given action.</p></div></div><div class="top"><p class="src"><a id="v:offsideRule" class="def">offsideRule</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a> <a href="src/Agda.Syntax.Parser.Layout.html#offsideRule" class="link">Source</a> <a href="#v:offsideRule" class="selflink">#</a></p><div class="doc"><p>Executed for the first token in each line (see <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code>),
    except when the last token was a layout keyword.</p><p>Checks the position of the token relative to the current layout context.
    If the token is</p><ul><li><em>to the left</em> :
        Exit the current block and a return virtual close brace (stay in the
        <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> state).</li><li><em>same column</em> :
        Exit the <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> state and return a virtual semi
        colon.</li><li><em>to the right</em> :
        Exit the <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> state and continue lexing.</li></ul></div></div><div class="top"><p class="src"><a id="v:newLayoutBlock" class="def">newLayoutBlock</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a> <a href="src/Agda.Syntax.Parser.Layout.html#newLayoutBlock" class="link">Source</a> <a href="#v:newLayoutBlock" class="selflink">#</a></p><div class="doc"><p>Start a new layout block. This is how to get out of the
    <code><a href="Agda-Syntax-Parser-Lexer.html#v:layout" title="Agda.Syntax.Parser.Lexer">layout</a></code> state. There are
    two possibilities:</p><ul><li>The current token is to the right of the confirmed layout column.</li><li>The current token is to the left of or in the same column as the confirmed
      layout column.</li></ul><p>In the first case everything is fine and we enter a new layout block at
    the column of the current token. In the second case we have an empty layout
    block so we enter the <code><a href="Agda-Syntax-Parser-Lexer.html#v:empty_layout" title="Agda.Syntax.Parser.Lexer">empty_layout</a></code> state. In both
    cases we return a virtual open brace without consuming any input.</p><p>Entering a new state when we know we want to generate a virtual <code class="inline-code">{}</code> may
    seem a bit roundabout. The thing is that we can only generate one token at
    a time, so the way to generate two tokens is to generate the first one and
    then enter a state in which the only thing you can do is generate the
    second one.</p></div></div><div class="top"><p class="src"><a id="v:emptyLayout" class="def">emptyLayout</a> :: <a href="Agda-Syntax-Parser-Alex.html#t:LexAction" title="Agda.Syntax.Parser.Alex">LexAction</a> <a href="Agda-Syntax-Parser-Tokens.html#t:Token" title="Agda.Syntax.Parser.Tokens">Token</a> <a href="src/Agda.Syntax.Parser.Layout.html#emptyLayout" class="link">Source</a> <a href="#v:emptyLayout" class="selflink">#</a></p><div class="doc"><p>This action is only executed from the <code><a href="Agda-Syntax-Parser-Lexer.html#v:empty_layout" title="Agda.Syntax.Parser.Lexer">empty_layout</a></code>
    state. It will exit this state, enter the <code><a href="Agda-Syntax-Parser-Lexer.html#v:bol" title="Agda.Syntax.Parser.Lexer">bol</a></code> state,
    and return a virtual close brace (closing the empty layout block started
    by <code><a href="Agda-Syntax-Parser-Layout.html#v:newLayoutBlock" title="Agda.Syntax.Parser.Layout">newLayoutBlock</a></code>).</p></div></div><div class="top"><p class="src"><a id="v:confirmLayout" class="def">confirmLayout</a> :: <a href="Agda-Syntax-Parser-Monad.html#t:Parser" title="Agda.Syntax.Parser.Monad">Parser</a> () <a href="src/Agda.Syntax.Parser.Layout.html#confirmLayout" class="link">Source</a> <a href="#v:confirmLayout" class="selflink">#</a></p><div class="doc"><p>At a new line, we confirm either existing tentative layout
   columns, or, if the last token was a layout keyword, the expected
   new layout column.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.30.0</p></div></body></html>