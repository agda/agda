<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Imperfect discrimination trees for indexing data by internal</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- syntax.</span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html"><span class="hs-identifier">Agda.TypeChecking.DiscrimTree</span></a></span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#insertDT"><span class="hs-identifier">insertDT</span></a></span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT"><span class="hs-identifier">lookupDT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#lookupUnifyDT"><span class="hs-identifier">lookupUnifyDT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier">QueryResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#deleteFromDT"><span class="hs-identifier">deleteFromDT</span></a></span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html"><span class="hs-identifier">Agda.Syntax.Internal</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html"><span class="hs-identifier">Agda.Syntax.Common</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Substitute.html"><span class="hs-identifier">Agda.TypeChecking.Substitute</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Telescope.html"><span class="hs-identifier">Agda.TypeChecking.Telescope</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Records.html"><span class="hs-identifier">Agda.TypeChecking.Records</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Reduce.html"><span class="hs-identifier">Agda.TypeChecking.Reduce</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html"><span class="hs-identifier">Agda.TypeChecking.Pretty</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.html"><span class="hs-identifier">Agda.TypeChecking.Monad</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Free.html"><span class="hs-identifier">Agda.TypeChecking.Free</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html"><span class="hs-identifier">Agda.TypeChecking.DiscrimTree.Types</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.Interaction.Options.ProfileOptions.html"><span class="hs-identifier">Agda.Interaction.Options.ProfileOptions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Profile</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Impossible.html"><span class="hs-identifier">Agda.Utils.Impossible</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Trie.html"><span class="hs-identifier">Agda.Utils.Trie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Utils.Trie.html#Trie"><span class="hs-identifier">Trie</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-comment">-- | Dummy term to use as a stand-in for expanded eta-records while</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- building instance trees.</span><span>
</span><span id="line-39"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#etaExpansionDummy"><span class="hs-identifier hs-type">etaExpansionDummy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span>
</span><span id="line-40"></span><span id="etaExpansionDummy"><span class="annot"><span class="annottext">etaExpansionDummy :: Term
</span><a href="Agda.TypeChecking.DiscrimTree.html#etaExpansionDummy"><span class="hs-identifier hs-var hs-var">etaExpansionDummy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DummyTermKind -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#Dummy"><span class="hs-identifier hs-var">Dummy</span></a></span><span> </span><span class="annot"><span class="annottext">DummyTermKind
</span><span class="hs-string">&quot;eta-record argument in instance head&quot;</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Extract a list of arguments from the list of eliminations; If</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- called while *adding* an instance, additionally replace any arguments</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- that might belong to an eta-record by dummy terms.</span><span>
</span><span id="line-45"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-type">termKeyElims</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Are we adding or looking up an instance?</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Continuation to compute the type of the arguments in the spine.</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Common.html#Arg"><span class="hs-identifier hs-type">Arg</span></a></span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ The spine.</span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- Since the case tree was generated with wildcards everywhere an eta</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- record appeared, if we're *looking up* an instance, we don't have to</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- do the censorship again.</span><span>
</span><span id="line-54"></span><span id="termKeyElims"><span class="annot"><span class="annottext">termKeyElims :: Bool -&gt; TCM Type -&gt; [Arg Term] -&gt; TCM (Int, [Term])
</span><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-var hs-var">termKeyElims</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TCM Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067506"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067506"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, [Term]) -&gt; TCM (Int, [Term])
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Arg Term] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067506"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Arg Term -&gt; Term) -&gt; [Arg Term] -&gt; [Term]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg Term -&gt; Term
forall e. Arg e -&gt; e
</span><a href="Agda.Syntax.Common.html#unArg"><span class="hs-identifier hs-var">unArg</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067506"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-var">termKeyElims</span></a></span><span> </span><span id="local-6989586621682067509"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067509"><span class="hs-identifier hs-var">precise</span></a></span></span><span> </span><span id="local-6989586621682067510"><span class="annot"><span class="annottext">TCM Type
</span><a href="#local-6989586621682067510"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682067511"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067511"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621682067602"><span class="annot"><span class="annottext">go :: Type -&gt; [Arg Term] -&gt; m (a, [Term])
</span><a href="#local-6989586621682067602"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682067603"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682067603"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Common.html#Arg"><span class="hs-identifier hs-type">Arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067605"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067605"><span class="hs-identifier hs-var">a</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682067606"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067606"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Dom Type -&gt; Abs Type -&gt; m (a, [Term]))
 -&gt; (Blocked Type -&gt; m (a, [Term])) -&gt; m (a, [Term]))
-&gt; (Blocked Type -&gt; m (a, [Term]))
-&gt; (Dom Type -&gt; Abs Type -&gt; m (a, [Term]))
-&gt; m (a, [Term])
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
-&gt; (Dom Type -&gt; Abs Type -&gt; m (a, [Term]))
-&gt; (Blocked Type -&gt; m (a, [Term]))
-&gt; m (a, [Term])
forall (m :: * -&gt; *) a.
MonadReduce m =&gt;
Type
-&gt; (Dom Type -&gt; Abs Type -&gt; m a) -&gt; (Blocked Type -&gt; m a) -&gt; m a
</span><a href="Agda.TypeChecking.Telescope.html#ifPiTypeB"><span class="hs-identifier hs-var">ifPiTypeB</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682067603"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blocker -&gt; m (a, [Term])
forall a. Blocker -&gt; m a
forall (m :: * -&gt; *) a. MonadBlock m =&gt; Blocker -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#patternViolation"><span class="hs-identifier hs-var">patternViolation</span></a></span><span> </span><span class="annot"><span class="annottext">(Blocker -&gt; m (a, [Term]))
-&gt; (Blocked Type -&gt; Blocker) -&gt; Blocked Type -&gt; m (a, [Term])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Blocked Type -&gt; Blocker
forall t a. Blocked' t a -&gt; Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#getBlocker"><span class="hs-identifier hs-var">getBlocker</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682067612"><span class="annot"><span class="annottext">Dom Type
</span><a href="#local-6989586621682067612"><span class="hs-identifier hs-var">dom</span></a></span></span><span> </span><span id="local-6989586621682067613"><span class="annot"><span class="annottext">Abs Type
</span><a href="#local-6989586621682067613"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-comment">-- Is this argument an eta record type --- or a blocked value? In</span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-comment">-- either case, we replace this position by a dummy, to make sure</span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-comment">-- that eta-equality is respected.</span><span>
</span><span id="line-63"></span><span>      </span><span id="local-6989586621682067614"><span class="annot"><a href="#local-6989586621682067614"><span class="hs-identifier hs-var">maybeEta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
-&gt; (Blocker -&gt; Type -&gt; m Bool)
-&gt; (NotBlocked -&gt; Type -&gt; m Bool)
-&gt; m Bool
forall t (m :: * -&gt; *) a.
(Reduce t, IsMeta t, MonadReduce m) =&gt;
t -&gt; (Blocker -&gt; t -&gt; m a) -&gt; (NotBlocked -&gt; t -&gt; m a) -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#ifBlocked"><span class="hs-identifier hs-var">ifBlocked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dom Type -&gt; Type
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span> </span><span class="annot"><span class="annottext">Dom Type
</span><a href="#local-6989586621682067612"><span class="hs-identifier hs-var">dom</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Blocker
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">NotBlocked
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067617"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682067617"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">Maybe (QName, [Arg Term]) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (QName, [Arg Term]) -&gt; Bool)
-&gt; m (Maybe (QName, [Arg Term])) -&gt; m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; m (Maybe (QName, [Arg Term]))
forall (m :: * -&gt; *).
(HasCallStack, HasConstInfo m) =&gt;
Type -&gt; m (Maybe (QName, [Arg Term]))
</span><a href="Agda.TypeChecking.Records.html#isEtaRecordType"><span class="hs-identifier hs-var">isEtaRecordType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682067617"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-67"></span><span>        </span><span id="local-6989586621682067621"><span class="annot"><a href="#local-6989586621682067621"><span class="hs-identifier hs-var hs-var">here</span></a></span></span><span>
</span><span id="line-68"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067614"><span class="hs-identifier hs-var">maybeEta</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="Agda.TypeChecking.DiscrimTree.html#etaExpansionDummy"><span class="hs-identifier hs-var">etaExpansionDummy</span></a></span><span>
</span><span id="line-69"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067605"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682067622"><span class="annot"><a href="#local-6989586621682067622"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067623"><span class="annot"><a href="#local-6989586621682067623"><span class="hs-identifier hs-var">there</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Context.html#addContext"><span class="hs-identifier hs-type">addContext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067612"><span class="hs-identifier hs-type">dom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067602"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Internal.html#unAbs"><span class="hs-identifier hs-var">unAbs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067613"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682067606"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067622"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682067621"><span class="hs-identifier hs-type">here</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682067623"><span class="hs-identifier hs-type">there</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="#local-6989586621682067602"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, [Term]) -&gt; m (a, [Term])
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><span class="annottext">TCM Type
</span><a href="#local-6989586621682067510"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">TCM Type -&gt; (Type -&gt; TCM (Int, [Term])) -&gt; TCM (Int, [Term])
forall a b. TCMT IO a -&gt; (a -&gt; TCMT IO b) -&gt; TCMT IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [Arg Term] -&gt; TCM (Int, [Term]))
-&gt; [Arg Term] -&gt; Type -&gt; TCM (Int, [Term])
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Arg Term] -&gt; TCM (Int, [Term])
forall {m :: * -&gt; *} {a}.
(MonadReduce m, MonadBlock m, HasConstInfo m, MonadAddContext m,
 Num a) =&gt;
Type -&gt; [Arg Term] -&gt; m (a, [Term])
</span><a href="#local-6989586621682067602"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067511"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-comment">-- | Ticky profiling for the reason behind &quot;inexactness&quot; in instance</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- search. If at some point while narrowing the set of candidates we had</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- to go through all the possibilities, one of these counters is</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- incremented.</span><span>
</span><span id="line-82"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#tickExplore"><span class="hs-identifier hs-type">tickExplore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span id="tickExplore"><span class="annot"><span class="annottext">tickExplore :: Term -&gt; TCM ()
</span><a href="Agda.TypeChecking.DiscrimTree.html#tickExplore"><span class="hs-identifier hs-var hs-var">tickExplore</span></a></span></span><span> </span><span id="local-6989586621682067628"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067628"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProfileOption -&gt; TCM () -&gt; TCM ()
forall (m :: * -&gt; *). MonadDebug m =&gt; ProfileOption -&gt; m () -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#whenProfile"><span class="hs-identifier hs-var">whenProfile</span></a></span><span> </span><span class="annot"><span class="annottext">ProfileOption
</span><a href="Agda.Interaction.Options.ProfileOptions.html#Instances"><span class="hs-identifier hs-var">Profile.Instances</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore&quot;</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067628"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Def&quot;</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Var&quot;</span></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067635"><span class="annot"><span class="annottext">Abs Term
</span><a href="#local-6989586621682067635"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-comment">-- These two are a hunch: just like FunK, it might be worth</span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">-- optimising for the case where a lambda is constant (which is</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">-- easy to handle, by just pretending the term is something else).</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- These would come up in e.g. Dec (PathP (&#955; i &#8594; Nat) x y)</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#NoAbs"><span class="hs-identifier hs-type">NoAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Abs Term
</span><a href="#local-6989586621682067635"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: constant function&quot;</span></span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Abs"><span class="hs-identifier hs-type">Abs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067638"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067638"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Abs Term
</span><a href="#local-6989586621682067635"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term -&gt; Bool
forall t. Free t =&gt; Int -&gt; t -&gt; Bool
</span><a href="Agda.TypeChecking.Free.html#freeIn"><span class="hs-operator hs-var">`freeIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067638"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: constant function&quot;</span></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Lam&quot;</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Lit&quot;</span></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Sort"><span class="hs-identifier hs-type">Sort</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Sort&quot;</span></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Level"><span class="hs-identifier hs-type">Level</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Level&quot;</span></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-type">MetaV</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: Meta&quot;</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#DontCare"><span class="hs-identifier hs-type">DontCare</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCM ()
forall (m :: * -&gt; *). MonadStatistics m =&gt; String -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Statistics.html#tick"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explore: DontCare&quot;</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TCM ()
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | Split a term into a 'Key' and some arguments. The 'Key' indicates</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- whether or not the 'Term' is in head-normal form, and provides a</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- quick way to match on the head.</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- The 'Int' argument indicates how free a variable must be to be</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- considered a 'LocalK'.</span><span>
</span><span id="line-111"></span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- Presently, non-head-normal terms end up with an empty argument list.</span><span>
</span><span id="line-113"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-type">splitTermKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#Blocker"><span class="hs-identifier hs-type">Blocker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span id="splitTermKey"><span class="annot"><span class="annottext">splitTermKey :: Bool -&gt; Int -&gt; Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-var hs-var">splitTermKey</span></a></span></span><span> </span><span id="local-6989586621682067648"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span></span><span> </span><span id="local-6989586621682067649"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067649"><span class="hs-identifier hs-var">local</span></a></span></span><span> </span><span id="local-6989586621682067650"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067650"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Blocker -&gt; TCM (Key, [Term], Blocker))
-&gt; TCM (Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. (Blocker -&gt; TCMT IO a) -&gt; TCMT IO a -&gt; TCMT IO a
forall (m :: * -&gt; *) a.
MonadBlock m =&gt;
(Blocker -&gt; m a) -&gt; m a -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#catchPatternErr"><span class="hs-identifier hs-var">catchPatternErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682067652"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067652"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#FlexK"><span class="hs-identifier hs-var">FlexK</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067652"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682067654"><span class="annot"><a href="#local-6989586621682067654"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067655"><span class="annot"><a href="#local-6989586621682067655"><span class="hs-identifier hs-var">tm'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term
-&gt; (Blocker -&gt; Term -&gt; TCMT IO (NotBlocked, Term))
-&gt; (NotBlocked -&gt; Term -&gt; TCMT IO (NotBlocked, Term))
-&gt; TCMT IO (NotBlocked, Term)
forall t (m :: * -&gt; *) a.
(Reduce t, IsMeta t, MonadReduce m) =&gt;
t -&gt; (Blocker -&gt; t -&gt; m a) -&gt; (NotBlocked -&gt; t -&gt; m a) -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#ifBlocked"><span class="hs-identifier hs-var">ifBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067650"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682067656"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067656"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blocker -&gt; TCMT IO (NotBlocked, Term)
forall a. Blocker -&gt; TCMT IO a
forall (m :: * -&gt; *) a. MonadBlock m =&gt; Blocker -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#patternViolation"><span class="hs-identifier hs-var">patternViolation</span></a></span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067656"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682067657"><span class="annot"><span class="annottext">NotBlocked
</span><a href="#local-6989586621682067657"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Term -&gt; (NotBlocked, Term))
-&gt; TCMT IO Term -&gt; TCMT IO (NotBlocked, Term)
forall a b. (a -&gt; b) -&gt; TCMT IO a -&gt; TCMT IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NotBlocked
</span><a href="#local-6989586621682067657"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCMT IO Term -&gt; TCMT IO (NotBlocked, Term))
-&gt; (Term -&gt; TCMT IO Term) -&gt; Term -&gt; TCMT IO (NotBlocked, Term)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; Term -&gt; m Term
</span><a href="Agda.TypeChecking.Monad.Builtin.html#constructorForm"><span class="hs-identifier hs-var">constructorForm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682067655"><span class="hs-identifier hs-type">tm'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- Adding a 'Def' to the key poses a few problems when opacity (or</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- abstractness) are involved (see issue #7304). Suppose we have an</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-comment">-- opaque binding `X = Y`, and an opaque instance `C X`. The problem</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- is as follows:</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">--   if we unfold X &#8594; Y when adding the instance, then it will not</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">--   get recorded as an instance for C X, only C Y; this is 7304b.</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">--   if we *don't* unfold X &#8594; Y, then it only gets added as an</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">--   instance of C X; in opaque blocks where X is allowed to unfold,</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-comment">--   we *won't* find it, because we're looking for C Y.</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- The solution is to throw our hands up and say &quot;not our problem&quot;.</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- The discrimination tree is allowed to return more results than</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- strictly necessary, after all, so the solution is to add an</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-comment">-- instance for *neither* of C X or C Y, but instead, to treat all</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-comment">-- 'Def's headed by 'AbstractDefn' as though they were flexible</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- (think &quot;as though they were metas&quot;).</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span> </span><span id="local-6989586621682067659"><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621682067659"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621682067660"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067660"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NotBlocked
</span><a href="Agda.Syntax.Internal.Blockers.html#ReallyNotBlocked"><span class="hs-identifier hs-var">ReallyNotBlocked</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NotBlocked
</span><a href="#local-6989586621682067654"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682067662"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067662"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Elims
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Elims -&gt; ([Arg Term], Elims)
forall a. [Elim' a] -&gt; ([Arg a], [Elim' a])
</span><a href="Agda.Syntax.Internal.Elim.html#splitApplyElims"><span class="hs-identifier hs-var">splitApplyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067660"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>      </span><span id="local-6989586621682067664"><span class="annot"><a href="#local-6989586621682067664"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">QName -&gt; TCMT IO Definition
forall (m :: * -&gt; *).
(HasConstInfo m, HasCallStack) =&gt;
QName -&gt; m Definition
</span><a href="Agda.TypeChecking.Monad.Signature.html#getConstInfo"><span class="hs-identifier hs-var">getConstInfo</span></a></span><span> </span><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621682067659"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#theDef"><span class="hs-identifier hs-var">theDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067664"><span class="hs-identifier hs-type">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#AbstractDefn"><span class="hs-identifier hs-type">AbstractDefn</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#FlexK"><span class="hs-identifier hs-var">FlexK</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">Defn
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682067669"><span class="annot"><a href="#local-6989586621682067669"><span class="hs-identifier hs-var">arity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067670"><span class="annot"><a href="#local-6989586621682067670"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCM Type -&gt; [Arg Term] -&gt; TCM (Int, [Term])
</span><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-var">termKeyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TCM Type
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Definition -&gt; Type
</span><a href="Agda.TypeChecking.Monad.Base.html#defType"><span class="hs-identifier hs-var">defType</span></a></span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621682067664"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067662"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#RigidK"><span class="hs-identifier hs-type">RigidK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067659"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067669"><span class="hs-identifier hs-type">arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682067670"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-type">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- When adding a quantified instance, we record how many 'Pi's we went</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- under, and only variables beyond those are considered LocalK. The</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- others are considered FlexK since they're &quot;pattern variables&quot; of</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- the instance.</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682067673"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067673"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621682067674"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067674"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067673"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067649"><span class="hs-identifier hs-var">local</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682067675"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067675"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Elims -&gt; Maybe [Arg Term]
forall a. [Elim' a] -&gt; Maybe [Arg a]
</span><a href="Agda.Syntax.Internal.Elim.html#allApplyElims"><span class="hs-identifier hs-var">allApplyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067674"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682067677"><span class="annot"><span class="annottext">ty :: TCM Type
</span><a href="#local-6989586621682067677"><span class="hs-identifier hs-var hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Dom Type -&gt; Type
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span> </span><span class="annot"><span class="annottext">(Dom Type -&gt; Type) -&gt; TCMT IO (Dom Type) -&gt; TCM Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO (Dom Type)
forall (m :: * -&gt; *).
(MonadDebug m, MonadTCEnv m) =&gt;
Int -&gt; m (Dom Type)
</span><a href="Agda.TypeChecking.Monad.Context.html#domOfBV"><span class="hs-identifier hs-var">domOfBV</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067673"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682067679"><span class="annot"><a href="#local-6989586621682067679"><span class="hs-identifier hs-var">arity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067680"><span class="annot"><a href="#local-6989586621682067680"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCM Type -&gt; [Arg Term] -&gt; TCM (Int, [Term])
</span><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-var">termKeyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span> </span><span class="annot"><span class="annottext">TCM Type
</span><a href="#local-6989586621682067677"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067675"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#LocalK"><span class="hs-identifier hs-type">LocalK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067673"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><a href="#local-6989586621682067649"><span class="hs-identifier hs-type">local</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682067679"><span class="hs-identifier hs-type">arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682067680"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-type">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-comment">-- When looking up an instance, it's better to treat variables and</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-comment">-- neutral definitions as rigid things regardless of their spines</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">-- (especially if they have projections), than it is to try to</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-comment">-- represent them accurately.</span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span> </span><span id="local-6989586621682067681"><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621682067681"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621682067682"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067682"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QName -&gt; Int -&gt; Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#RigidK"><span class="hs-identifier hs-var">RigidK</span></a></span><span> </span><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621682067681"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682067683"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067683"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621682067684"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067684"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067683"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067649"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#LocalK"><span class="hs-identifier hs-var">LocalK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067683"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067649"><span class="hs-identifier hs-var">local</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Con"><span class="hs-identifier hs-type">Con</span></a></span><span> </span><span id="local-6989586621682067686"><span class="annot"><span class="annottext">ConHead
</span><a href="#local-6989586621682067686"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067687"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067687"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682067688"><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067688"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Elims -&gt; Maybe [Arg Term]
forall a. [Elim' a] -&gt; Maybe [Arg a]
</span><a href="Agda.Syntax.Internal.Elim.html#allApplyElims"><span class="hs-identifier hs-var">allApplyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621682067687"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-162"></span><span>        </span><span id="local-6989586621682067689"><span class="annot"><span class="annottext">q :: QName
</span><a href="#local-6989586621682067689"><span class="hs-identifier hs-var hs-var hs-var">q</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConHead -&gt; QName
</span><a href="Agda.Syntax.Internal.html#conName"><span class="hs-identifier hs-var">conName</span></a></span><span> </span><span class="annot"><span class="annottext">ConHead
</span><a href="#local-6989586621682067686"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span id="local-6989586621682067691"><span class="annot"><span class="annottext">ty :: TCM Type
</span><a href="#local-6989586621682067691"><span class="hs-identifier hs-var hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Definition -&gt; Type
</span><a href="Agda.TypeChecking.Monad.Base.html#defType"><span class="hs-identifier hs-var">defType</span></a></span><span> </span><span class="annot"><span class="annottext">(Definition -&gt; Type) -&gt; TCMT IO Definition -&gt; TCM Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">QName -&gt; TCMT IO Definition
forall (m :: * -&gt; *).
(HasConstInfo m, HasCallStack) =&gt;
QName -&gt; m Definition
</span><a href="Agda.TypeChecking.Monad.Signature.html#getConstInfo"><span class="hs-identifier hs-var">getConstInfo</span></a></span><span> </span><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621682067689"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682067692"><span class="annot"><a href="#local-6989586621682067692"><span class="hs-identifier hs-var">arity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067693"><span class="annot"><a href="#local-6989586621682067693"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCM Type -&gt; [Arg Term] -&gt; TCM (Int, [Term])
</span><a href="Agda.TypeChecking.DiscrimTree.html#termKeyElims"><span class="hs-identifier hs-var">termKeyElims</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067648"><span class="hs-identifier hs-var">precise</span></a></span><span> </span><span class="annot"><span class="annottext">TCM Type
</span><a href="#local-6989586621682067691"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg Term]
</span><a href="#local-6989586621682067688"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#RigidK"><span class="hs-identifier hs-type">RigidK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067689"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067692"><span class="hs-identifier hs-type">arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682067693"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-type">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Pi"><span class="hs-identifier hs-type">Pi</span></a></span><span> </span><span id="local-6989586621682067695"><span class="annot"><span class="annottext">Dom Type
</span><a href="#local-6989586621682067695"><span class="hs-identifier hs-var">dom</span></a></span></span><span> </span><span id="local-6989586621682067696"><span class="annot"><span class="annottext">Abs Type
</span><a href="#local-6989586621682067696"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-comment">-- If we're looking at a non-dependent function type, then we</span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-comment">-- might as well represent the codomain accurately; Otherwise,</span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- turn the codomain into a wildcard.</span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-comment">-- The use of a dummy term *shouldn't* leak to the user, because</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">-- when we call splitTermKey again, it'll be handled by the last</span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-comment">-- case, and become a FlexK.</span><span>
</span><span id="line-176"></span><span>        </span><span id="local-6989586621682067697"><span class="annot"><span class="annottext">ret' :: Term
</span><a href="#local-6989586621682067697"><span class="hs-identifier hs-var hs-var">ret'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Abs Term -&gt; Maybe Term
forall a. (Free a, Subst a) =&gt; Abs a -&gt; Maybe a
</span><a href="Agda.TypeChecking.Substitute.Class.html#isNoAbs"><span class="hs-identifier hs-var">isNoAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Term
forall t a. Type'' t a -&gt; a
</span><a href="Agda.Syntax.Internal.html#unEl"><span class="hs-identifier hs-var">unEl</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Term) -&gt; Abs Type -&gt; Abs Term
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Abs Type
</span><a href="#local-6989586621682067696"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-177"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682067700"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067700"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067700"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-178"></span><span>          </span><span class="annot"><span class="annottext">Maybe Term
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term
HasCallStack =&gt; Term
</span><a href="Agda.Syntax.Internal.html#__DUMMY_TERM__"><span class="hs-identifier hs-var">__DUMMY_TERM__</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hiding -&gt; Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#PiK"><span class="hs-identifier hs-var">PiK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dom Type -&gt; Hiding
forall a. LensHiding a =&gt; a -&gt; Hiding
</span><a href="Agda.Syntax.Common.html#getHiding"><span class="hs-identifier hs-var">getHiding</span></a></span><span> </span><span class="annot"><span class="annottext">Dom Type
</span><a href="#local-6989586621682067695"><span class="hs-identifier hs-var">dom</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; Term
forall t a. Type'' t a -&gt; a
</span><a href="Agda.Syntax.Internal.html#unEl"><span class="hs-identifier hs-var">unEl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dom Type -&gt; Type
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span> </span><span class="annot"><span class="annottext">Dom Type
</span><a href="#local-6989586621682067695"><span class="hs-identifier hs-var">dom</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067697"><span class="hs-identifier hs-var">ret'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067704"><span class="annot"><span class="annottext">Abs Term
</span><a href="#local-6989586621682067704"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-comment">-- Constant lambdas come up quite a bit, particularly (in cubical</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-comment">-- mode) as the domain of a PathP. Having this trick improves the</span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-comment">-- indexing of 'Dec' instances in the 1Lab significantly.</span><span>
</span><span id="line-185"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682067705"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067705"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Abs Term -&gt; Maybe Term
forall a. (Free a, Subst a) =&gt; Abs a -&gt; Maybe a
</span><a href="Agda.TypeChecking.Substitute.Class.html#isNoAbs"><span class="hs-identifier hs-var">isNoAbs</span></a></span><span> </span><span class="annot"><span class="annottext">Abs Term
</span><a href="#local-6989586621682067704"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#ConstK"><span class="hs-identifier hs-var">ConstK</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067705"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- Probably not a good idea for accurate indexing if universes</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- overlap literally everything else.</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="Agda.Syntax.Internal.html#Sort"><span class="hs-identifier hs-type">Sort</span></a></span><span> </span><span class="annot"><span class="annottext">Sort
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#SortK"><span class="hs-identifier hs-var">SortK</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.split&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067650"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">(Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#FlexK"><span class="hs-identifier hs-var">FlexK</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-type">termPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-196"></span><span id="termPath"><span class="annot"><span class="annottext">termPath :: Int -&gt; Bool -&gt; Int -&gt; [Key] -&gt; [Term] -&gt; TCM [Key]
</span><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-var hs-var">termPath</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067711"><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067711"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Key] -&gt; TCM [Key]
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Key] -&gt; TCM [Key]) -&gt; [Key] -&gt; TCM [Key]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">[Key] -&gt; [Key]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067711"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-var">termPath</span></a></span><span> </span><span id="local-6989586621682067714"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067714"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621682067715"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067715"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621682067716"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067716"><span class="hs-identifier hs-var">local</span></a></span></span><span> </span><span id="local-6989586621682067717"><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067717"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Key] -&gt; TCM [Key]
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Key] -&gt; TCM [Key]) -&gt; [Key] -&gt; TCM [Key]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">[Key] -&gt; [Key]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067717"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-var">termPath</span></a></span><span> </span><span id="local-6989586621682067718"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067718"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621682067719"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067719"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621682067720"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067720"><span class="hs-identifier hs-var">local</span></a></span></span><span> </span><span id="local-6989586621682067721"><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067721"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682067722"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067722"><span class="hs-identifier hs-var">tm</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682067723"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067723"><span class="hs-identifier hs-var">todo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-comment">-- We still want to ignore abstractness at the very top-level of</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-comment">-- instance heads, for issue #6941, to ensure that each instance ends</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-comment">-- up in the right 'class'. See the comment in `splitTermKey` about</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-comment">-- abstract definitions.</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682067724"><span class="annot"><a href="#local-6989586621682067724"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067725"><span class="annot"><a href="#local-6989586621682067725"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067726"><span class="annot"><a href="#local-6989586621682067726"><span class="hs-identifier hs-var">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067719"><span class="hs-identifier hs-var">toplevel</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TCM (Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; m a -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Signature.html#ignoreAbstractMode"><span class="hs-identifier hs-var">ignoreAbstractMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Int -&gt; Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-var">splitTermKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067720"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067722"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int -&gt; Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-var">splitTermKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067720"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067722"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-type">reportSDoc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tc.instance.discrim.add&quot;</span></span><span> </span><span class="annot"><span class="hs-number">666</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;k:  &quot;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067724"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;as: &quot;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067725"><span class="hs-keyword hs-type">as</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;blk:&quot;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067726"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;lim:&quot;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067718"><span class="hs-identifier hs-type">limit</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-type">termPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067718"><span class="hs-identifier hs-type">limit</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682067720"><span class="hs-identifier hs-type">local</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067724"><span class="hs-identifier hs-type">k</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682067721"><span class="hs-identifier hs-type">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682067725"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621682067723"><span class="hs-identifier hs-type">todo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- | Maximum length for the keys (thus, depth for the discrimination</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- tree) that should be used.</span><span>
</span><span id="line-219"></span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- Adding an instance still causes reduction of everything 'rigid' in</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- the type of the instance (so if normalisation is slow, so will be</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- adding the instance) but this limit prevents us from building a</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- discrimination tree with 2^32 intermediate @case 0 of suc &#8594; ...@</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- nodes.</span><span>
</span><span id="line-225"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#discrimTreeDepthLimit"><span class="hs-identifier hs-type">discrimTreeDepthLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-226"></span><span id="discrimTreeDepthLimit"><span class="annot"><span class="annottext">discrimTreeDepthLimit :: Int
</span><a href="Agda.TypeChecking.DiscrimTree.html#discrimTreeDepthLimit"><span class="hs-identifier hs-var hs-var">discrimTreeDepthLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-comment">-- | Insert a value into the discrimination tree, turning variables into</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- rigid locals or wildcards depending on the given scope.</span><span>
</span><span id="line-230"></span><span id="local-6989586621682067259"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#insertDT"><span class="hs-identifier hs-type">insertDT</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067259"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067259"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Number of variables to consider wildcards, e.g. the number of leading invisible pis in an instance type.</span></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The term to use as a key</span></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682067259"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067259"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067259"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-237"></span><span id="insertDT"><span class="annot"><span class="annottext">insertDT :: forall a.
(Ord a, PrettyTCM a) =&gt;
Int -&gt; Term -&gt; a -&gt; DiscrimTree a -&gt; TCM (DiscrimTree a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#insertDT"><span class="hs-identifier hs-var hs-var">insertDT</span></a></span></span><span> </span><span id="local-6989586621682067759"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067759"><span class="hs-identifier hs-var">local</span></a></span></span><span> </span><span id="local-6989586621682067760"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067760"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621682067761"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682067761"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span id="local-6989586621682067762"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067762"><span class="hs-identifier hs-var">tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>  </span><span id="local-6989586621682067763"><span class="annot"><a href="#local-6989586621682067763"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool -&gt; Int -&gt; [Key] -&gt; [Term] -&gt; TCM [Key]
</span><a href="Agda.TypeChecking.DiscrimTree.html#termPath"><span class="hs-identifier hs-var">termPath</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Agda.TypeChecking.DiscrimTree.html#discrimTreeDepthLimit"><span class="hs-identifier hs-var">discrimTreeDepthLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067759"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067760"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682067764"><span class="annot"><a href="#local-6989586621682067764"><span class="hs-identifier hs-var hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Key] -&gt; a -&gt; DiscrimTree a
forall a. [Key] -&gt; a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#singletonDT"><span class="hs-identifier hs-var">singletonDT</span></a></span><span> </span><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621682067763"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682067761"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-type">reportSDoc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tc.instance.discrim.add&quot;</span></span><span> </span><span class="annot"><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;added value&quot;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067761"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;to discrimination tree with case&quot;</span></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-type">nest</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067764"><span class="hs-identifier hs-type">it</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;its type:&quot;</span></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-type">nest</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067760"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;its path:&quot;</span></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-type">nest</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-type">prettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067763"><span class="hs-identifier hs-type">path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#mergeDT"><span class="hs-identifier hs-type">mergeDT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067764"><span class="hs-identifier hs-type">it</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067762"><span class="hs-identifier hs-type">tree</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- | If a term matches this key, how many arguments does it place on the</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- spine?</span><span>
</span><span id="line-252"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#keyArity"><span class="hs-identifier hs-type">keyArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-253"></span><span id="keyArity"><span class="annot"><span class="annottext">keyArity :: Key -&gt; Int
</span><a href="Agda.TypeChecking.DiscrimTree.html#keyArity"><span class="hs-identifier hs-var hs-var">keyArity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#RigidK"><span class="hs-identifier hs-type">RigidK</span></a></span><span> </span><span class="annot"><span class="annottext">QName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067769"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067769"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067769"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#LocalK"><span class="hs-identifier hs-type">LocalK</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682067770"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067770"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682067770"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#PiK"><span class="hs-identifier hs-type">PiK</span></a></span><span> </span><span class="annot"><span class="annottext">Hiding
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#ConstK"><span class="hs-identifier hs-var">ConstK</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#SortK"><span class="hs-identifier hs-var">SortK</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#FlexK"><span class="hs-identifier hs-var">FlexK</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-keyword">data</span><span> </span><span id="QueryResult"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span></span><span> </span><span id="local-6989586621682067266"><span class="annot"><a href="#local-6989586621682067266"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QueryResult"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="resultValues"><span class="annot"><span class="annottext">forall a. QueryResult a -&gt; Set a
</span><a href="Agda.TypeChecking.DiscrimTree.html#resultValues"><span class="hs-identifier hs-var hs-var">resultValues</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="#local-6989586621682067266"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="resultBlocker"><span class="annot"><span class="annottext">forall a. QueryResult a -&gt; Blocker
</span><a href="Agda.TypeChecking.DiscrimTree.html#resultBlocker"><span class="hs-identifier hs-var hs-var">resultBlocker</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#Blocker"><span class="hs-identifier hs-type">Blocker</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682067274"><span id="local-6989586621682067777"><span id="local-6989586621682067781"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067274"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067274"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span id="local-6989586621682067788"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067788"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682067789"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067789"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682067790"><span class="annot"><span class="annottext">&lt;&gt; :: QueryResult a -&gt; QueryResult a -&gt; QueryResult a
</span><span class="hs-operator hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span id="local-6989586621682067791"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067791"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621682067792"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067792"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Blocker -&gt; QueryResult a
forall a. Set a -&gt; Blocker -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067788"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Set a -&gt; Set a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067791"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067789"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Blocker -&gt; Blocker -&gt; Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#unblockOnEither"><span class="hs-operator hs-var">`unblockOnEither`</span></a></span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682067792"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682067278"><span id="local-6989586621682067799"><span id="local-6989586621682067803"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067278"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067278"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-270"></span><span>  </span><span id="local-6989586621682067808"><span class="annot"><span class="annottext">mempty :: QueryResult a
</span><span class="hs-identifier hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Blocker -&gt; QueryResult a
forall a. Set a -&gt; Blocker -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span id="local-6989586621682067280"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#setResult"><span class="hs-identifier hs-type">setResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="#local-6989586621682067280"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067280"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-273"></span><span id="setResult"><span class="annot"><span class="annottext">setResult :: forall a. Set a -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#setResult"><span class="hs-identifier hs-var hs-var">setResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set a -&gt; Blocker -&gt; QueryResult a)
-&gt; Blocker -&gt; Set a -&gt; QueryResult a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Blocker -&gt; QueryResult a
forall a. Set a -&gt; Blocker -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span><span> </span><span class="annot"><span class="annottext">Blocker
</span><a href="Agda.Syntax.Internal.Blockers.html#neverUnblock"><span class="hs-identifier hs-var">neverUnblock</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span id="local-6989586621682067282"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#blockerResult"><span class="hs-identifier hs-type">blockerResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#Blocker"><span class="hs-identifier hs-type">Blocker</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067282"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-276"></span><span id="blockerResult"><span class="annot"><span class="annottext">blockerResult :: forall a. Blocker -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#blockerResult"><span class="hs-identifier hs-var hs-var">blockerResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Blocker -&gt; QueryResult a
forall a. Set a -&gt; Blocker -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-var">QueryResult</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- | Look up a 'Term' in the given discrimination tree, treating local</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- variables as rigid symbols. The returned set is guaranteed to contain</span><span>
</span><span id="line-280"></span><span class="hs-comment">-- everything that could overlap the given key.</span><span>
</span><span id="line-281"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT"><span class="hs-identifier hs-type">lookupDT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682067285"><span class="annot"><a href="#local-6989586621682067285"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067285"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067285"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067285"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067285"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span id="lookupDT"><span class="annot"><span class="annottext">lookupDT :: forall a.
(Ord a, PrettyTCM a) =&gt;
Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT"><span class="hs-identifier hs-var hs-var">lookupDT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
forall a.
(Ord a, PrettyTCM a) =&gt;
Bool -&gt; Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT%27"><span class="hs-identifier hs-var">lookupDT'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- | Look up a 'Term' in the given discrimination tree, treating local</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- variables as wildcards.</span><span>
</span><span id="line-286"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#lookupUnifyDT"><span class="hs-identifier hs-type">lookupUnifyDT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682067817"><span class="annot"><a href="#local-6989586621682067817"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067817"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067817"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067817"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067817"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="lookupUnifyDT"><span class="annot"><span class="annottext">lookupUnifyDT :: forall a.
(Ord a, PrettyTCM a) =&gt;
Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#lookupUnifyDT"><span class="hs-identifier hs-var hs-var">lookupUnifyDT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
forall a.
(Ord a, PrettyTCM a) =&gt;
Bool -&gt; Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT%27"><span class="hs-identifier hs-var">lookupDT'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT%27"><span class="hs-identifier hs-type">lookupDT'</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682067287"><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Should local variables be treated as rigid?</span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The term to use as key</span></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span id="lookupDT%27"><span class="annot"><span class="annottext">lookupDT' :: forall a.
(Ord a, PrettyTCM a) =&gt;
Bool -&gt; Term -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="Agda.TypeChecking.DiscrimTree.html#lookupDT%27"><span class="hs-identifier hs-var hs-var">lookupDT'</span></a></span></span><span> </span><span id="local-6989586621682067964"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067964"><span class="hs-identifier hs-var">localsRigid</span></a></span></span><span> </span><span id="local-6989586621682067965"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067965"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span id="local-6989586621682067966"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067966"><span class="hs-identifier hs-var">tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Term] -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067965"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067966"><span class="hs-identifier hs-var">tree</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="#local-6989586621682067968"><span class="hs-identifier hs-type">split</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.Blockers.html#Blocker"><span class="hs-identifier hs-type">Blocker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621682067968"><span class="annot"><span class="annottext">split :: Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="#local-6989586621682067968"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span id="local-6989586621682067969"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067969"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067964"><span class="hs-identifier hs-var">localsRigid</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int -&gt; Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-var">splitTermKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067969"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="#local-6989586621682067968"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span id="local-6989586621682067970"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682067970"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621682067971"><span class="annot"><a href="#local-6989586621682067971"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO Int
forall (m :: * -&gt; *). MonadTCEnv m =&gt; m Int
</span><a href="Agda.TypeChecking.Monad.Context.html#getContextSize"><span class="hs-identifier hs-var">getContextSize</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#splitTermKey"><span class="hs-identifier hs-type">splitTermKey</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682067971"><span class="hs-identifier hs-type">ctx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067970"><span class="hs-identifier hs-type">tm</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><a href="#local-6989586621682067973"><span class="hs-identifier hs-type">ignoreAbstractMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682067297"><span class="annot"><a href="#local-6989586621682067297"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067297"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067297"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span id="local-6989586621682067973"><span class="annot"><span class="annottext">ignoreAbstractMaybe :: forall a. Bool -&gt; TCM a -&gt; TCM a
</span><a href="#local-6989586621682067973"><span class="hs-identifier hs-var hs-var">ignoreAbstractMaybe</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCMT IO a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; m a -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Signature.html#ignoreAbstractMode"><span class="hs-identifier hs-var">ignoreAbstractMode</span></a></span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><a href="#local-6989586621682067973"><span class="hs-identifier hs-var">ignoreAbstractMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCMT IO a -&gt; TCMT IO a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-comment">-- Match a spine against *all* clauses.</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="#local-6989586621682067976"><span class="hs-identifier hs-type">explore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>  </span><span id="local-6989586621682067976"><span class="annot"><span class="annottext">explore :: [Term]
-&gt; [Term]
-&gt; [Term]
-&gt; [(Key, DiscrimTree a)]
-&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067976"><span class="hs-identifier hs-var hs-var">explore</span></a></span></span><span> </span><span id="local-6989586621682067977"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067977"><span class="hs-identifier hs-var">sp0</span></a></span></span><span> </span><span id="local-6989586621682067978"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067978"><span class="hs-identifier hs-var">sp1</span></a></span></span><span> </span><span id="local-6989586621682067979"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067979"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682067980"><span class="annot"><span class="annottext">[(Key, DiscrimTree a)]
</span><a href="#local-6989586621682067980"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-311"></span><span>      </span><span id="local-6989586621682067981"><span class="annot"><span class="annottext">cont :: (Key, DiscrimTree a) -&gt; QueryResult a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067981"><span class="hs-identifier hs-var hs-var">cont</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682067982"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682067982"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682067983"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067983"><span class="hs-identifier hs-var">trie</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682067984"><span class="annot"><span class="annottext">QueryResult a
</span><a href="#local-6989586621682067984"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-comment">-- At the moment, explore will always be called with empty args.</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-comment">-- But even if this restriction is lifted in the future, we have</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-comment">-- to be careful about exploring. Consider:</span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">--   instance</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-comment">--     _ : Foo (con x)</span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-comment">--   &#8866; Foo ?0</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span>        </span><span class="hs-comment">-- Since ?0 might be applied to more or less arguments than the</span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-comment">-- one argument that is expected to be between sp0 and sp1 after</span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-comment">-- matching con, we need to make sure that the spine has the</span><span>
</span><span id="line-324"></span><span>        </span><span class="hs-comment">-- right number of arguments, otherwise the (sp0, t:sp1) pattern</span><span>
</span><span id="line-325"></span><span>        </span><span class="hs-comment">-- for a Case will fail.</span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682067985"><span class="annot"><span class="annottext">args' :: [Term]
</span><a href="#local-6989586621682067985"><span class="hs-identifier hs-var hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Term] -&gt; [Term]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key -&gt; Int
</span><a href="Agda.TypeChecking.DiscrimTree.html#keyArity"><span class="hs-identifier hs-var">keyArity</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682067982"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Term] -&gt; [Term]) -&gt; [Term] -&gt; [Term]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067979"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; [Term] -&gt; [Term]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; Term
String -&gt; Term
</span><a href="Agda.Syntax.Internal.html#__DUMMY_TERM_WITH__"><span class="hs-identifier hs-var">__DUMMY_TERM_WITH__</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_pad&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682067989"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682067989"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621682067989"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.discrim.lookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">99</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-329"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;explore&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Key -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682067982"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key -&gt; Int
</span><a href="Agda.TypeChecking.DiscrimTree.html#keyArity"><span class="hs-identifier hs-var">keyArity</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682067982"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Term] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067979"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Functor m =&gt; Int -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiscrimTree a -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; DiscrimTree a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067983"><span class="hs-identifier hs-var">trie</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;sp0:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067977"><span class="hs-identifier hs-var">sp0</span></a></span><span>
</span><span id="line-332"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;sp1:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067978"><span class="hs-identifier hs-var">sp1</span></a></span><span>
</span><span id="line-333"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;args: &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067979"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-334"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;args':&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067985"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-335"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-336"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QueryResult a -&gt; QueryResult a -&gt; QueryResult a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QueryResult a
</span><a href="#local-6989586621682067984"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(QueryResult a -&gt; QueryResult a)
-&gt; TCM (QueryResult a) -&gt; TCM (QueryResult a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Term] -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067977"><span class="hs-identifier hs-var">sp0</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; [Term] -&gt; [Term]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067985"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; [Term] -&gt; [Term]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067978"><span class="hs-identifier hs-var">sp1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682067983"><span class="hs-identifier hs-var">trie</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>    </span><span class="annot"><span class="annottext">((Key, DiscrimTree a) -&gt; QueryResult a -&gt; TCM (QueryResult a))
-&gt; QueryResult a -&gt; [(Key, DiscrimTree a)] -&gt; TCM (QueryResult a)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; b -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldrM</span></span><span> </span><span class="annot"><span class="annottext">(Key, DiscrimTree a) -&gt; QueryResult a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067981"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">QueryResult a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[(Key, DiscrimTree a)]
</span><a href="#local-6989586621682067980"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621682067967"><span class="annot"><span class="annottext">match :: Bool -&gt; [Term] -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067967"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span id="local-6989586621682067991"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067991"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621682067992"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067992"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#EmptyDT"><span class="hs-identifier hs-var">EmptyDT</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryResult a -&gt; TCM (QueryResult a)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">QueryResult a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682067994"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067994"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621682067995"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067995"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DoneDT"><span class="hs-identifier hs-type">DoneDT</span></a></span><span> </span><span id="local-6989586621682067997"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067997"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; QueryResult a
forall a. Set a -&gt; QueryResult a
</span><a href="Agda.TypeChecking.DiscrimTree.html#setResult"><span class="hs-identifier hs-var">setResult</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067997"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">QueryResult a -&gt; TCM () -&gt; TCM (QueryResult a)
forall a b. a -&gt; TCMT IO b -&gt; TCMT IO a
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.discrim.lookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">99</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;done&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682067995"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;  &#8594;&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Set a -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Set a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682067997"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>  </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682067999"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067999"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621682068000"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068000"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621682068001"><span class="annot"><span class="annottext">tree :: DiscrimTree a
</span><a href="#local-6989586621682068001"><span class="hs-identifier hs-var">tree</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#CaseDT"><span class="hs-identifier hs-type">CaseDT</span></a></span><span> </span><span id="local-6989586621682068003"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068003"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621682068004"><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068004"><span class="hs-identifier hs-var">branches</span></a></span></span><span> </span><span id="local-6989586621682068005"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068005"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682068006"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068006"><span class="hs-identifier hs-var">sp0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068007"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068007"><span class="hs-identifier hs-var">t</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682068008"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068008"><span class="hs-identifier hs-var">sp1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Term] -&gt; ([Term], [Term])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068003"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068000"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-350"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682068010"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068010"><span class="hs-identifier hs-var hs-var">sp0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068011"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068011"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682068012"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068012"><span class="hs-identifier hs-var hs-var">sp1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Term] -&gt; ([Term], [Term])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068003"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068000"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-351"></span><span>      </span><span id="local-6989586621682068013"><span class="annot"><span class="annottext">visit :: Key -&gt; [Term] -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682068013"><span class="hs-identifier hs-var hs-var hs-var">visit</span></a></span></span><span> </span><span id="local-6989586621682068014"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682068014"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621682068015"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068015"><span class="hs-identifier hs-var">sp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Key -&gt; Map Key (DiscrimTree a) -&gt; Maybe (DiscrimTree a)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682068014"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068004"><span class="hs-identifier hs-var">branches</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682068017"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068017"><span class="hs-identifier hs-var">m</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Term] -&gt; DiscrimTree a -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068015"><span class="hs-identifier hs-var">sp'</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068017"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">Maybe (DiscrimTree a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QueryResult a -&gt; TCM (QueryResult a)
forall a. a -&gt; TCMT IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">QueryResult a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067999"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.discrim.lookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">99</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;match&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068010"><span class="hs-identifier hs-var">sp0</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;&#171;&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068011"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;&#187;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068012"><span class="hs-identifier hs-var">sp1</span></a></span><span>
</span><span id="line-357"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; DiscrimTree a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068001"><span class="hs-identifier hs-var">tree</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-comment">-- TODO (Amy, 2024-02-12): Could use reduceB in splitTermKey, and</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-comment">-- the blocker here, to suspend instances more precisely when there</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-comment">-- is an ambiguity.</span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TCM (Key, [Term], Blocker) -&gt; TCM (Key, [Term], Blocker)
forall a. Bool -&gt; TCM a -&gt; TCM a
</span><a href="#local-6989586621682067973"><span class="hs-identifier hs-var">ignoreAbstractMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682067999"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; TCM (Key, [Term], Blocker)
</span><a href="#local-6989586621682067968"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068011"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCM (Key, [Term], Blocker)
-&gt; ((Key, [Term], Blocker) -&gt; TCM (QueryResult a))
-&gt; TCM (QueryResult a)
forall a b. TCMT IO a -&gt; (a -&gt; TCMT IO b) -&gt; TCMT IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-364"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#FlexK"><span class="hs-identifier hs-var">FlexK</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068019"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068019"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068020"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682068020"><span class="hs-identifier hs-var">blocker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.discrim.lookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">99</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-367"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;flexible term was forced&quot;</span></span><span>
</span><span id="line-368"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;t:&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; TCMT IO Doc) -&gt; TCMT IO Term -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Term
forall a (m :: * -&gt; *). (Instantiate a, MonadReduce m) =&gt; a -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#instantiate"><span class="hs-identifier hs-var">instantiate</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068011"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;will explore&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Key (DiscrimTree a) -&gt; Int
forall a. Map Key a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068004"><span class="hs-identifier hs-var">branches</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;branches&quot;</span></span><span>
</span><span id="line-370"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="annottext">Term -&gt; TCM ()
</span><a href="Agda.TypeChecking.DiscrimTree.html#tickExplore"><span class="hs-identifier hs-var">tickExplore</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621682068011"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-comment">-- If we have a &quot;flexible head&quot; at this position then instance</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-comment">-- search *at this point* degenerates to looking for all</span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-comment">-- possible matches.</span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-comment">-- In any nested CaseDTs, however, it's possible for us to</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-comment">-- recover and go back to productively matching. Consider:</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-380"></span><span>        </span><span class="hs-comment">--    instance</span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-comment">--      xa : X T1 A</span><span>
</span><span id="line-382"></span><span>        </span><span class="hs-comment">--      xb : X T2 B</span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-comment">--    &#8866; X ?0 A</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- Since ?0 is way too flabby to narrow which of T1 or T2 should</span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-comment">-- be taken, we take both. But then we match A against A and B:</span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-comment">-- this query will only return {xa}.</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span>        </span><span id="local-6989586621682068023"><span class="annot"><a href="#local-6989586621682068023"><span class="hs-identifier hs-var">branches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Term]
-&gt; [Term]
-&gt; [Term]
-&gt; [(Key, DiscrimTree a)]
-&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682067976"><span class="hs-identifier hs-var">explore</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068010"><span class="hs-identifier hs-var">sp0</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068012"><span class="hs-identifier hs-var">sp1</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068019"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">([(Key, DiscrimTree a)] -&gt; TCM (QueryResult a))
-&gt; [(Key, DiscrimTree a)] -&gt; TCM (QueryResult a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a) -&gt; [(Key, DiscrimTree a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068004"><span class="hs-identifier hs-var">branches</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span id="local-6989586621682068025"><span class="annot"><a href="#local-6989586621682068025"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682068000"><span class="hs-identifier hs-type">ts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682068005"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621682068025"><span class="hs-identifier hs-type">rest</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621682068023"><span class="hs-identifier hs-type">branches</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#blockerResult"><span class="hs-identifier hs-type">blockerResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682068020"><span class="hs-identifier hs-type">blocker</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682068026"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682068026"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068027"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068027"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682068028"><span class="annot"><span class="annottext">Blocker
</span><a href="#local-6989586621682068028"><span class="hs-identifier hs-var">blocker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682068029"><span class="annot"><span class="annottext">sp' :: [Term]
</span><a href="#local-6989586621682068029"><span class="hs-identifier hs-var hs-var hs-var">sp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068010"><span class="hs-identifier hs-var">sp0</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; [Term] -&gt; [Term]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068027"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; [Term] -&gt; [Term]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068012"><span class="hs-identifier hs-var">sp1</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>        </span><span class="hs-comment">-- Actually take the branch corresponding to our rigid head.</span><span>
</span><span id="line-399"></span><span>        </span><span id="local-6989586621682068030"><span class="annot"><a href="#local-6989586621682068030"><span class="hs-identifier hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Key -&gt; [Term] -&gt; TCM (QueryResult a)
</span><a href="#local-6989586621682068013"><span class="hs-identifier hs-var">visit</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682068026"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068029"><span class="hs-identifier hs-var">sp'</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-comment">-- When exploring the rest of the tree, the value we cased on</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-comment">-- has to be put back in the tree. mergeDT does not perform</span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-comment">-- commuting conversions to ensure that variables aren't</span><span>
</span><span id="line-404"></span><span>        </span><span class="hs-comment">-- repeatedly cased on.</span><span>
</span><span id="line-405"></span><span>        </span><span id="local-6989586621682068031"><span class="annot"><a href="#local-6989586621682068031"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621682068000"><span class="hs-identifier hs-type">ts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682068005"><span class="hs-identifier hs-type">rest</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621682068031"><span class="hs-identifier hs-type">rest</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621682068030"><span class="hs-identifier hs-type">branch</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><a href="#local-6989586621682067967"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682068032"><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068032"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621682068033"><span class="annot"><span class="annottext">tree :: DiscrimTree a
</span><a href="#local-6989586621682068033"><span class="hs-identifier hs-var">tree</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#CaseDT"><span class="hs-identifier hs-type">CaseDT</span></a></span><span> </span><span id="local-6989586621682068034"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068034"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682068035"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068035"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.instance.discrim.lookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">99</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-411"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;IMPOSSIBLE match&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; [Term] -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Term]
</span><a href="#local-6989586621682068032"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; DiscrimTree a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068033"><span class="hs-identifier hs-var">tree</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-comment">-- This really is impossible: since each branch is annotated with</span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-comment">-- its arity, we only take branches corresponding to neutrals which</span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-comment">-- exploded into enough arguments.</span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><span class="annottext">TCM (QueryResult a)
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span class="annot"><span class="hs-comment">-- | Smart constructor for a leaf node.</span></span><span>
</span><span id="line-420"></span><span id="local-6989586621682067322"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#doneDT"><span class="hs-identifier hs-type">doneDT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="#local-6989586621682067322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067322"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-421"></span><span id="doneDT"><span class="annot"><span class="annottext">doneDT :: forall a. Set a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.html#doneDT"><span class="hs-identifier hs-var hs-var">doneDT</span></a></span></span><span> </span><span id="local-6989586621682068038"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068038"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.null</span></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068038"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
forall a. DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#EmptyDT"><span class="hs-identifier hs-var">EmptyDT</span></a></span><span>
</span><span id="line-422"></span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#doneDT"><span class="hs-identifier hs-var">doneDT</span></a></span><span> </span><span id="local-6989586621682068040"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068040"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; DiscrimTree a
forall a. Set a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#DoneDT"><span class="hs-identifier hs-var">DoneDT</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068040"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- | Remove a set of values from the discrimination tree. The tree is</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- rebuilt so that cases with no leaves are removed.</span><span>
</span><span id="line-426"></span><span id="local-6989586621682067326"><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.html#deleteFromDT"><span class="hs-identifier hs-type">deleteFromDT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621682067326"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="#local-6989586621682067326"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067326"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DiscrimTree"><span class="hs-identifier hs-type">DiscrimTree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682067326"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-427"></span><span id="deleteFromDT"><span class="annot"><span class="annottext">deleteFromDT :: forall a. Ord a =&gt; Set a -&gt; DiscrimTree a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.html#deleteFromDT"><span class="hs-identifier hs-var hs-var">deleteFromDT</span></a></span></span><span> </span><span id="local-6989586621682068045"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068045"><span class="hs-identifier hs-var">gone</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-428"></span><span>  </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#EmptyDT"><span class="hs-identifier hs-var">EmptyDT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
forall a. DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#EmptyDT"><span class="hs-identifier hs-var">EmptyDT</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#DoneDT"><span class="hs-identifier hs-type">DoneDT</span></a></span><span> </span><span id="local-6989586621682068046"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068046"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; DiscrimTree a
forall a. Set a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.html#doneDT"><span class="hs-identifier hs-var">doneDT</span></a></span><span> </span><span class="annot"><span class="annottext">(Set a -&gt; DiscrimTree a) -&gt; Set a -&gt; DiscrimTree a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Set a -&gt; Set a -&gt; Set a
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.difference</span></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068046"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068045"><span class="hs-identifier hs-var">gone</span></a></span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.DiscrimTree.Types.html#CaseDT"><span class="hs-identifier hs-type">CaseDT</span></a></span><span> </span><span id="local-6989586621682068048"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068048"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621682068049"><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068049"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682068050"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068050"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621682068051"><span class="annot"><span class="annottext">del :: DiscrimTree a -&gt; Maybe (DiscrimTree a)
</span><a href="#local-6989586621682068051"><span class="hs-identifier hs-var hs-var">del</span></a></span></span><span> </span><span id="local-6989586621682068052"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068052"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; DiscrimTree a -&gt; DiscrimTree a
forall a. Ord a =&gt; Set a -&gt; DiscrimTree a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.html#deleteFromDT"><span class="hs-identifier hs-var">deleteFromDT</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068045"><span class="hs-identifier hs-var">gone</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068052"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#EmptyDT"><span class="hs-identifier hs-var">EmptyDT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (DiscrimTree a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-434"></span><span>        </span><span id="local-6989586621682068053"><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068053"><span class="hs-identifier hs-var">dt'</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a -&gt; Maybe (DiscrimTree a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068053"><span class="hs-identifier hs-var">dt'</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>      </span><span id="local-6989586621682068054"><span class="annot"><span class="annottext">s' :: Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068054"><span class="hs-identifier hs-var hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DiscrimTree a -&gt; Maybe (DiscrimTree a))
-&gt; Map Key (DiscrimTree a) -&gt; Map Key (DiscrimTree a)
forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a -&gt; Maybe (DiscrimTree a)
</span><a href="#local-6989586621682068051"><span class="hs-identifier hs-var">del</span></a></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068049"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span id="local-6989586621682068056"><span class="annot"><span class="annottext">k' :: DiscrimTree a
</span><a href="#local-6989586621682068056"><span class="hs-identifier hs-var hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set a -&gt; DiscrimTree a -&gt; DiscrimTree a
forall a. Ord a =&gt; Set a -&gt; DiscrimTree a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.html#deleteFromDT"><span class="hs-identifier hs-var">deleteFromDT</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621682068045"><span class="hs-identifier hs-var">gone</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068050"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a) -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.null</span></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068054"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068056"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-439"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Map Key (DiscrimTree a) -&gt; DiscrimTree a -&gt; DiscrimTree a
forall a.
Int -&gt; Map Key (DiscrimTree a) -&gt; DiscrimTree a -&gt; DiscrimTree a
</span><a href="Agda.TypeChecking.DiscrimTree.Types.html#CaseDT"><span class="hs-identifier hs-var">CaseDT</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682068048"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Map Key (DiscrimTree a)
</span><a href="#local-6989586621682068054"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">DiscrimTree a
</span><a href="#local-6989586621682068056"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-440"></span></pre></body></html>