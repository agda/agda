<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Agda.TypeChecking.Generalize</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">Agda</span><ul class="links" id="page-menu"><li><a href="src/Agda.TypeChecking.Generalize.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Agda.TypeChecking.Generalize</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module implements the type checking part of generalisable variables. When we get here we have
a type checking problem for a type (or telescope) containing a known set of generalisable variables
and we need to produce a well typed type (or telescope) with the correct generalisations. For instance,
given</p><pre>variable
  A  : Set
  n  : Nat
  xs : Vec A n

foo : SomeType xs
</pre><p>generalisation should produce <code class="inline-code">{A : Set} {n : Nat} {xs : Vec A n} &#8594; SomeType xs</code> for the type of
<code class="inline-code">foo</code>.</p><p>The functions <code><a href="Agda-TypeChecking-Generalize.html#v:generalizeType" title="Agda.TypeChecking.Generalize">generalizeType</a></code> and <code><a href="Agda-TypeChecking-Generalize.html#v:generalizeTelescope" title="Agda.TypeChecking.Generalize">generalizeTelescope</a></code> don't have access to the abstract syntax to
be type checked (<code class="inline-code">SomeType xs</code> in the example). Instead they are provided a type checking action
that delivers a <code><a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a></code> or a <code><a href="Agda-Syntax-Internal.html#t:Telescope" title="Agda.Syntax.Internal">Telescope</a></code>. The challenge is setting up a context in which <code class="inline-code">SomeType
xs</code> can be type checked successfully by this action, without knowing what the telescope of
generalised variables will be. Once we have computed this telescope the result needs to be
transformed into a well typed type abstracted over it.</p><p><strong>At no point are we allowed to cheat!</strong> Any transformation between well typed terms needs to be done
by well typed substitutions.</p><p>The key idea is to run the type checking action in the context of a single variable of an unknown
type. Once we know what variables to generalise over this type is instantiated to a fresh record
type with a field for each generalised variable. Turning the result of action into something valid
in the context of the generalised variables is then a simple substitution unpacking the record
variable.</p><p>In more detail, generalisation proceeds as follows:</p><ul><li>Add a variable <code class="inline-code">genTel</code> of an unknown type to the context (<code>withGenRecVar</code>).</li></ul><pre>  (genTel : _GenTel)
</pre><ul><li>Create metavariables for the generalisable variables appearing in the problem and their
  dependencies (<code>createGenValues</code>). In the example this would be</li></ul><pre>  (genTel : _GenTel) &#8866;
    _A  : Set
    _n  : Nat
    _xs : Vec _A _n
</pre><ul><li>Run the type checking action (<code>createMetasAndTypeCheck</code>), binding the mentioned generalisable
  variables to the corresponding newly created metavariables. This binding is stored in
  <code><a href="Agda-TypeChecking-Monad-Base.html#v:eGeneralizedVars" title="Agda.TypeChecking.Monad.Base">eGeneralizedVars</a></code> and picked up in <code><a href="Agda-TypeChecking-Rules-Application.html#v:inferDef" title="Agda.TypeChecking.Rules.Application">inferDef</a></code></li></ul><pre>  (genTel : _GenTel) &#8866; SomeType (_xs genTel)
</pre><ul><li>Compute the telescope of generalised variables (<code>computeGeneralization</code>). This is done by taking
  the unconstrained metavariables created by <code>createGenValues</code> or created during the type checking
  action and sorting them into a well formed telescope.</li></ul><pre>  {A : Set} {n : Nat} {xs : Vec A n}
</pre><ul><li>Create a record type <code class="inline-code">GeneralizeTel</code> whose fields are the generalised variables and instantiate
  the type of <code class="inline-code">genTel</code> to it (<code>createGenRecordType</code>).</li></ul><pre>  record GeneralizeTel : Set&#8321; where
    constructor mkGeneralizeTel
    field
      A  : Set
      n  : Nat
      xs : Vec A n
</pre><ul><li>Solve the metavariables with their corresponding projections from <code class="inline-code">genTel</code>.</li></ul><pre>  _A  := &#955; genTel &#8594; genTel .A
  _n  := &#955; genTel &#8594; genTel .n
  _xs := &#955; genTel &#8594; genTel .xs
</pre><ul><li>Build the unpacking substitution (<code>unpackSub</code>) that maps terms in <code class="inline-code">(genTel : GeneralizeTel)</code> to
  terms in the context of the generalised variables by substituting a record value for <code class="inline-code">genTel</code>.</li></ul><pre>  {A : Set} {n : Nat} {xs : Vec A n} &#8866; [mkGeneralizeTel A n xs / genTel] : (genTel : GeneralizeTel)
</pre><ul><li>Build the final result by applying the unpacking substitution to the result of the type checking
  action and abstracting over the generalised telescope.</li></ul><pre>  {A : Set} {n : Nat} {xs : Vec A n} &#8594; SomeType (_xs (mkGeneralizeTel A n xs)) ==
  {A : Set} {n : Nat} {xs : Vec A n} &#8594; SomeType xs
</pre><ul><li>In case of <code><a href="Agda-TypeChecking-Generalize.html#v:generalizeType" title="Agda.TypeChecking.Generalize">generalizeType</a></code> return the resulting pi type.</li><li>In case of <code><a href="Agda-TypeChecking-Generalize.html#v:generalizeTelescope" title="Agda.TypeChecking.Generalize">generalizeTelescope</a></code> enter the resulting context, applying the unpacking substitution
  to let bindings (TODO #6916: and also module applications!) created in the telescope, and call the
  continuation.</li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:generalizeType">generalizeType</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Set.html#t:Set" title="Data.Set">Set</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a>], <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>)</li><li class="src short"><a href="#v:generalizeType-39-">generalizeType'</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Set.html#t:Set" title="Data.Set">Set</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> (<a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>, a) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a>], <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>, a)</li><li class="src short"><a href="#v:generalizeTelescope">generalizeTelescope</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Map-Strict.html#t:Map" title="Data.Map.Strict">Map</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> <a href="Agda-Syntax-Abstract-Name.html#t:Name" title="Agda.Syntax.Abstract.Name">Name</a> -&gt; (<span class="keyword">forall</span> a1. (<a href="Agda-Syntax-Internal.html#t:Telescope" title="Agda.Syntax.Internal">Telescope</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a1) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a1) -&gt; ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:Name" title="Agda.Syntax.Abstract.Name">Name</a>] -&gt; <a href="Agda-Syntax-Internal.html#t:Telescope" title="Agda.Syntax.Internal">Telescope</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:generalizeType" class="def">generalizeType</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Set.html#t:Set" title="Data.Set">Set</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a>], <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>) <a href="src/Agda.TypeChecking.Generalize.html#generalizeType" class="link">Source</a> <a href="#v:generalizeType" class="selflink">#</a></p><div class="doc"><p>Generalize a type over a set of (used) generalizable variables.</p></div></div><div class="top"><p class="src"><a id="v:generalizeType-39-" class="def">generalizeType'</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Set.html#t:Set" title="Data.Set">Set</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> (<a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>, a) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a>], <a href="Agda-Syntax-Internal.html#t:Type" title="Agda.Syntax.Internal">Type</a>, a) <a href="src/Agda.TypeChecking.Generalize.html#generalizeType%27" class="link">Source</a> <a href="#v:generalizeType-39-" class="selflink">#</a></p><div class="doc"><p>Allow returning additional information from the type checking action.</p></div></div><div class="top"><p class="src"><a id="v:generalizeTelescope" class="def">generalizeTelescope</a> :: <a href="https://hackage.haskell.org/package/containers-0.7/docs/Data-Map-Strict.html#t:Map" title="Data.Map.Strict">Map</a> <a href="Agda-Syntax-Abstract-Name.html#t:QName" title="Agda.Syntax.Abstract.Name">QName</a> <a href="Agda-Syntax-Abstract-Name.html#t:Name" title="Agda.Syntax.Abstract.Name">Name</a> -&gt; (<span class="keyword">forall</span> a1. (<a href="Agda-Syntax-Internal.html#t:Telescope" title="Agda.Syntax.Internal">Telescope</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a1) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a1) -&gt; ([<a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Agda-Syntax-Abstract-Name.html#t:Name" title="Agda.Syntax.Abstract.Name">Name</a>] -&gt; <a href="Agda-Syntax-Internal.html#t:Telescope" title="Agda.Syntax.Internal">Telescope</a> -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a) -&gt; <a href="Agda-TypeChecking-Monad-Base.html#t:TCM" title="Agda.TypeChecking.Monad.Base">TCM</a> a <a href="src/Agda.TypeChecking.Generalize.html#generalizeTelescope" class="link">Source</a> <a href="#v:generalizeTelescope" class="selflink">#</a></p><div class="doc"><p>Generalize a telescope over a set of generalizable variables.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.30.0</p></div></body></html>